{# Store results in a variable #}
{% set result = {} %}
{% if security_rules.gathered is defined and expiring_schedules is defined %}
  {% for schedule in expiring_schedules %}
    {% set schedule_rules = [] %}
    {% for rule in security_rules.gathered %}
      {% if rule.schedule == schedule.name %}
        {% set rule_info = {
          'name': rule.name,
          'description': rule.description | default('No description'),
          'source_zone': rule.source_zone | default(['any']) | join(', '),
          'destination_zone': rule.destination_zone | default(['any']) | join(', '),
          'source_ip': rule.source_ip | default(['any']) | join(', '),
          'destination_ip': rule.destination_ip | default(['any']) | join(', '),
          'application': rule.application | default(['any']) | join(', '),
          'action': rule.action | default('allow'),
          'disabled': rule.disabled | default(false)
        } %}
        {% set _ = schedule_rules.append(rule_info) %}
      {% endif %}
    {% endfor %}
    {% if schedule_rules | length > 0 %}
      {% set _ = result.update({schedule.name: {
        'schedule_info': schedule,
        'rules': schedule_rules
      }}) %}
    {% endif %}
  {% endfor %}
{% endif %}
{% set vars = namespace(result=result) %}