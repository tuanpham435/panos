---
- name: Check PAN-OS schedule objects and related security rules
  hosts: panorama
  connection: local
  gather_facts: false
  
  vars:
    provider:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"
      
  tasks:
    - name: Gather all schedule objects
      paloaltonetworks.panos.panos_schedule_object:
        provider: "{{ provider }}"
        state: "gathered"
        gathered_filter: '*'
      register: schedule_objects

    - name: Gather security rules
      paloaltonetworks.panos.panos_security_rule:
        provider: "{{ provider }}"
        state: "gathered"
        gathered_filter: '*'
      register: security_rules

    - name: Display affected security rules
      ansible.builtin.debug:
        msg: |
          Schedule: {{ schedule_objects }}
          Security Rule: {{ security_rules }}

    # - name: Send email notification
    #   community.general.mail:
    #     host: smtp.example.com
    #     port: 587
    #     username: "{{ smtp_user }}"
    #     password: "{{ smtp_pass }}"
    #     to: "{{ admin_email }}"
    #     subject: "PAN-OS Security Rules with Expiring Schedules"
    #     body: |
    #       The following schedule objects are expiring within 7 days:
          
    #       {% for schedule in expiring_schedules %}
    #       Schedule Object:
    #       - Name: {{ schedule.name }}
    #         End Date: {{ (schedule.non_recurring_date_time.split('-')[1]).split('@')[0] }}
          
    #       Affected Security Rules:
    #       {% for rule in affected_rules %}
    #       {% if rule.schedule == schedule.name %}
    #       - Rule Name: {{ rule.name }}
    #         Description: {{ rule.description | default('No description') }}
    #       {% endif %}
    #       {% endfor %}
          
    #       {% endfor %}
    #   when: affected_rules is defined and affected_rules | length > 0